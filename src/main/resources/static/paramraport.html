<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📊 Reports FX (Header/Footer Seçilebilir)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .page-max{max-width:1100px}
    .btn-w{min-width:120px}
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
  <div class="container page-max">
    <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="#">
      <span>📊</span><span>Reports FX</span>
      <span class="badge text-bg-primary ms-2">/reportsfx</span>
    </a>
    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="whoami" class="text-muted small me-2">Misafir</span>
      <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal" id="btnShowLogin">Giriş</button>
      <button class="btn btn-outline-secondary btn-sm" id="btnLogout">Çıkış</button>
    </div>
  </div>
</nav>

<main class="container page-max my-4">
  <div id="authWarn" class="alert alert-warning">
    Raporları indirebilmek için önce <b>giriş</b> yapın.
  </div>

  <!-- GÖMÜLEBİLİR KART (mevcut sayfana direkt kopyalayabilirsin) -->
  <div class="card border-primary">
    <div class="card-header d-flex align-items-center justify-content-between">
      <span>Ürünler — Header/Footer Seçilebilir</span>
      <span class="badge text-bg-primary">/reportsfx/products</span>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Başlık (title)</label>
          <input class="form-control" id="fxTitle" value="Ürünler Raporu" placeholder="Ürünler Raporu">
        </div>
        <div class="col-md-3">
          <label class="form-label">Alt başlık (subtitle)</label>
          <input class="form-control" id="fxSubtitle" placeholder="örn: Eylül 2025">
        </div>
        <div class="col-md-2">
          <label class="form-label">Header</label>
          <select class="form-select" id="fxHeader">
            <option value="1" selected>Basit (1)</option>
            <option value="2">Logo + Başlık (2)</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Footer</label>
          <select class="form-select" id="fxFooter">
            <option value="1" selected>Sayfa No + Tarih (1)</option>
            <option value="2">İmza Alanı (2)</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Arama (q)</label>
          <input class="form-control" id="fxQ" placeholder="örn: vida">
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-primary btn-w" id="fxBtnPdf">PDF</button>
        <button class="btn btn-success btn-w" id="fxBtnXlsx">Excel</button>
      </div>

      <div class="form-text mt-2">
        <code>/reportsfx/products.pdf</code> ve <code>/reportsfx/products.xlsx</code> uçları çağrılır.  
        Parametreler: <code>header</code>, <code>footer</code>, <code>title</code>, <code>subtitle</code>, <code>q</code>.
      </div>
    </div>
  </div>
</main>

<!-- Toasts -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
  <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="status" aria-live="polite" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">Mesaj</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Kapat"></button>
    </div>
  </div>
</div>

<!-- Login Modal (opsiyonel, senin eski API ile uyumlu) -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="loginForm">
      <div class="modal-header">
        <h5 class="modal-title">Giriş Yap</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Kullanıcı Adı</label>
        <input class="form-control mb-3" id="loginUser" placeholder="admin" value="admin">
        <label class="form-label">Şifre</label>
        <input class="form-control" id="loginPass" type="password" placeholder="••••••••" value="admin123">
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit" id="btnDoLogin">Giriş</button>
      </div>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ---------------------------
  // Helpers (senin önceki client ile aynı mantık)
  // ---------------------------
  function showToast(msg){
    document.getElementById('toastBody').textContent = msg;
    new bootstrap.Toast(document.getElementById('appToast'), { delay: 2500 }).show();
  }

  function buildQuery(params){
    const q = new URLSearchParams();
    Object.entries(params).forEach(([k,v])=>{
      if(v!==undefined && v!==null && String(v).trim()!=='') q.append(k, v);
    });
    const s = q.toString();
    return s ? ('?' + s) : '';
  }

  function setWhoAmI(){
    const token = localStorage.getItem('token');
    const name = localStorage.getItem('username');
    $('#whoami').text(token ? (name ? ('Girişli: ' + name) : 'Giriş yapıldı') : 'Misafir');
    $('#authWarn').toggleClass('d-none', !!token);
    const disabled = !token;
    $('#fxBtnPdf,#fxBtnXlsx').prop('disabled', disabled).toggleClass('disabled', disabled);
  }

  async function downloadAuth(url, filename){
    const token = localStorage.getItem('token');
    if(!token){ showToast('Önce giriş yapın.'); return; }
    try{
      const resp = await fetch(url, { headers: { 'Authorization':'Bearer '+token }});
      if(!resp.ok){
        let msg = 'İndirme başarısız (' + resp.status + ')';
        try{
          const ct = resp.headers.get('Content-Type')||'';
          if(ct.includes('application/json')){
            const j = await resp.json();
            msg = j.message || j.error || JSON.stringify(j);
          }else{
            const t = await resp.text(); if(t) msg = t;
          }
        }catch(_){}
        showToast(msg);
        return;
      }
      const blob = await resp.blob();
      const u = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = u; a.download = filename; a.style.display = 'none';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(u), 1500);
    }catch(err){
      showToast('Ağ hatası: ' + (err.message||err));
    }
  }

  // ---------------------------
  // Auth (opsiyonel demo)
  // ---------------------------
  $('#loginForm').on('submit', async (e)=>{
    e.preventDefault();
    const user = $('#loginUser').val().trim();
    const pass = $('#loginPass').val();
    $('#btnDoLogin').prop('disabled', true);
    try{
      const resp = await fetch('/auth/login', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ username:user, password:pass })
      });
      if(!resp.ok){ showToast('Giriş başarısız ('+resp.status+')'); }
      else{
        const data = await resp.json();
        if(!data.token){ showToast('Token alınamadı.'); return; }
        localStorage.setItem('token', data.token);
        localStorage.setItem('username', data.user || user);
        setWhoAmI();
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        showToast('Giriş başarılı.');
      }
    }catch(err){
      showToast('Ağ hatası: ' + (err.message||err));
    }finally{
      $('#btnDoLogin').prop('disabled', false);
    }
  });

  $('#btnLogout').on('click', ()=>{
    localStorage.removeItem('token');
    localStorage.removeItem('username');
    setWhoAmI();
    showToast('Çıkış yapıldı.');
  });

  // ---------------------------
  // Reports FX buttons (ReportFxController)
  // ---------------------------
  $('#fxBtnPdf').on('click', ()=>{
    const title = $('#fxTitle').val().trim();
    const subtitle = $('#fxSubtitle').val().trim();
    const header = $('#fxHeader').val();
    const footer = $('#fxFooter').val();
    const q = $('#fxQ').val().trim();
    const url = '/reportsfx/products.pdf' + buildQuery({ title, subtitle, header, footer, q });
    downloadAuth(url, 'urunler.pdf');
  });

  $('#fxBtnXlsx').on('click', ()=>{
    const title = $('#fxTitle').val().trim();
    const subtitle = $('#fxSubtitle').val().trim();
    const header = $('#fxHeader').val();
    const footer = $('#fxFooter').val();
    const q = $('#fxQ').val().trim();
    const url = '/reportsfx/products.xlsx' + buildQuery({ title, subtitle, header, footer, q });
    downloadAuth(url, 'urunler.xlsx');
  });

  // ---------------------------
  // Init
  // ---------------------------
  document.addEventListener('DOMContentLoaded', ()=>{
    setWhoAmI();
  });
</script>
</body>
</html>
